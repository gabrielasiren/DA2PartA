---
title: "Data Analytics II: Project Part A"
author: |
    | 57
    | Gabriela Siren, Didrik Gentili, Anna Gao, Ludwig Fredriksson
    | 25601, 25550, 25811, 25632
date: "2023-01-29"
output: pdf_document
df_print: paged
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(kableExtra)
library(ggplot2)
library(tibble)
library(rmarkdown)
library(knitr)
library(tidyverse)
library(tinytex)
library(dplyr)
library(broom)
library(purrr)
```


```{r setup Importing data}
data <- read_excel("SegmentData57.xlsx")
```

## A.1 - Explorative Data Analysis (EDA)

```{r A.1.1 Statistics table: numerical variable and proportion}
stats <- function(x){c("Mean " = mean(x)
                       ,"Stan. Deviaton " = sd(x)
                       ,"Minimum " = min(x)
                       , "Q1 " = quantile(x,probs=0.25)
                       ," Median " = median(x)
                       , "Q3 " = quantile(x, probs = 0.75)
                       ,"Maximum " = max(x))}
summaryStatsTable <-sapply(c(data[1:1], data[3:4]),stats)


#number of rows in the data table
rowD <- nrow(data)

ownHomeY = sum(data$ownHome == "ownYes") /rowD
ownHomeN = sum(data$ownHome == "ownNo") /rowD

subY = sum(data$subscribe == "subYes") /rowD
subN = sum(data$subscribe == "subNo") /rowD

mStats <- sum(data$gender == "Male") /rowD
fStats <- sum(data$gender == "Female") /rowD


H0 <- c(fStats, ownHomeN, subN)
H1 <- c(mStats, ownHomeY, subY)


categories <- rbind(H0,H1)
rownames(categories) = c("Female or False", "Male or True")

kables(
  list(
    kable(
      summaryStatsTable, digits = 2, col.names = c("Age","Income", "Kids"), valign = "t", booktabs = "True"
      )
  ,
    kable(
      categories, digits = 3, col.names = c("Gender","OwnsHome", "Subscribes"), valign = "t", booktabs = "True"
      )
  
  ),caption =  "Summary table for all variables") %>%
kable_styling(latex_options = "hold_position")
```
|   As shown by Table 1, ages range between $17$ to $77$ with a median of $39$. The mean age is $40.74$ which is slightly larger than the median. Additionally, the majority of the ages are in between $33$ and $48.25$. 
|   The income has a very large range, from roughly $11000$ to $139000$. The median, $53000$ and mean, $52000$ are closer to the minimum than the maximum meaning the data is skewed towards the lower values. The 3rd quartile is also very close to the median/mean meaning that there are some potential extreme values.
|   The kids are also skewed towards lower values. The range goes from $0$ to $7$ but the mean is $1.32$ while the median is $1$. This all gives us an accurate picture of the distribution of the data.
|
|   On the other hand, there is a relatively even proportion between two of the categorical variables, excluding the subscribers. For example, While there is roughly $4$ percent difference between males and females, they are both around $50%$. However, the proportion of subscribers is not distributed evenly as more than $85%$ of the sample does not subscribe. While this tells that the majority do not subscribe and that the sample has an even proportion of categories, this does not give us specific categorical values, for example, whether more Females or Males subscribe.


```{r A.1.2 Age histogram, fig.dim = c(4,4), fig.align='center'}

d1 <- data$age
d2 <- data$income
d3 <- data$kids

hist(d1, breaks=50, main = "Histogram of Age", xlab= "Aggregate age")
```

|   The histogram is very centered around the mean while the median is a bit greater than where the mode is. Additionally, there seems to be an observation at $77$ which it could potentially be an outlier.  


```{r A.1.2 Income histogram, fig.dim = c(4,4), fig.align='center'}
hist(d2, breaks=100, main = "Histogram of Income", xlab= "Aggregate income")
```

|   The income histogram is also centered around its mean and median. There is an observation at roughly $139000$ which is definitely an outlier in this case. 


```{r A.1.2 Kids histogram, fig.dim = c(4,4), fig.align='center'}
hist(d3, breaks=30, main = "Histogram of Kids", xlab= "Aggregate kids")

```

|   The histogram of Kids is centered around the minimum rather than median or the mean and this could be because of the outlier at $7$. The median in this case is more central than the mean as a result of this outlier. 

```{r A.1.2 Aggregate Boxplot, fig.dim = c(4,4), fig.align='center'}

#Aggregate income boxplot
boxplot(d2,
        main = "Aggregate Income boxplot",
        xlab = "Income",
        ylab = "Age",
        horizontal = TRUE,
        las=1)
```

|   The Aggregate Income boxplots supports the claims made from the histogram. While there is quite a even distribution centered around the median, there is an extreme value at around $139000$. The quartiles, and the maximum and minimum are also more or less evenly distributed. 


```{r A.1.2 Segmented Boxplot, fig.dim = c(4,4), fig.align='center'}
#Segmented income boxplot
seg_sm<-data[data$Segment=="Suburb mix",]
seg_uh<-data[data$Segment=="Urban hip",]
seg_t<-data[data$Segment=="Travelers",]
seg_mu<-data[data$Segment=="Moving up",]


boxplot(data$income~data$Segment,
        main = "Boxplots for Segmented Income",
        names = c("Suburb Mix", "Urban Hip", "Travelers", "Moving Up"),
        las = 1,
        horizontal = TRUE,
        ylab = "",
        xlab = "Income",
        cex.axis = 0.7 # decrease the font label of the y axis
        )


```

|   As shown by the boxplot above, there is a significant difference between the data from different segments. For example, the median moving up income is around $20000$ while for Travelers it is $65000$. Urban hip and Suburb mix have a slightly lower median income at around $52000$ and $50000$ respectively. Furthermore, while the Travelers segment has a far outlier, it does not affect the median so the current boxplot is accurate.  
|   Additionally, there is also a much lower minimum and maximum value for Moving Up compared to the rest. The Moving Up and Urban Hip segment is also not skewed compared to the other two. Travelers is slightly skewed towards the left while Suburban mix is skewed to the right. 



```{r A.1.3}

```

|   
|   Do the variables Income and Age appear to be (approximately) normally distributed? Can you think of a suitable distribution for the variable children? 
|
|   The Income and Age variables appear to be approximately normally distributed, even if there appears to be two modes in the Age variable, as mentioned above. 
|
|   The Children variable is not approximately normally distributed as it appears rather like a Chi-squared distribution. The distribution is very skewed to the right, with the mode furthest to the left. 


## A.2 - Confidence Intervals

```{r A.2.1, comment= " "}


# references
travelersdata = data[data$Segment == "Travelers",]
urban_hipdata = data[data$Segment == "Urban hip",]
suburb_mixdata = data[data$Segment == "Suburb mix",]
movingUpData <- data[data$Segment == "Moving up",]
maleData <- data[data$gender == "Male",]
femaleData <- data[data$gender == "Female",]

# definitions for income
travelersdata_income <- travelersdata$income
urban_hipdata_income <- urban_hipdata$income
suburb_mixdata_income <- suburb_mixdata$income
movingUpData_income <- movingUpData$income
maleData_income <- maleData$income
femaleData_income <- femaleData$income

income_agg <- data$income
n <- length(income_agg)
m <- mean(income_agg)
s <- sd(income_agg)
z <- qt(0.95, n-1)

ME<-z*s/(n^(0.5))


LCL = m - ME
UCL = m + ME

t <- c(ME,LCL,UCL)

# getting the sample sizes
nx = length(travelersdata_income)
ny = nrow(urban_hipdata)
nz = nrow(suburb_mixdata)
nu = nrow(movingUpData)

# data for travelers
mx <- mean(travelersdata_income)
sx <- sd(travelersdata_income)

# data for urban
my <- mean(urban_hipdata_income)
sy <- sd(urban_hipdata_income)

# data for suburbMix
mz <- mean(suburb_mixdata_income)
sz <- sd(suburb_mixdata_income)

# data for MovingUp
mu <- mean(movingUpData_income)
su <- sd(movingUpData_income)

meT<-z*sx/(nx^(0.5))

lclT <- mx - meT
uclT <- mx + meT

tT <- cbind(meT,lclT,uclT)


meU<-z*sy/(ny^(0.5))

lclU = my - meU
uclU = my + meU

tU <- cbind(meU,lclU,uclU)

meS<-z*sz/(nz^(0.5))

lclS = mz - meS
uclS = mz + meS

tS <- cbind(meS,lclS,uclS)

meM<-z*su/(nu^(0.5))

lclM = mu - meM
uclM = mu + meM




# to get the data from the segmented levels  and male / female look at how we did it in A.4.

```



```{r A.2.1 References, comment= " "}

tTestAgg <- t.test(income_agg, conf.level = 0.90)
tTestTra <- t.test(travelersdata_income, conf.level = 0.90)
tTestUrb <- t.test(urban_hipdata_income, conf.level = 0.90)
tTestSub <- t.test(suburb_mixdata_income, conf.level = 0.90)
tTestMov <- t.test(movingUpData_income, conf.level = 0.90)
tTestMal <- t.test(maleData_income,conf.level = 0.90)
tTestFem <- t.test(femaleData_income, conf.level = 0.90)

finaltTest <- map_df(list(tTestAgg,tTestTra,tTestUrb,tTestSub,tTestMov, tTestMal, tTestFem), tidy)

finaltTest[,c("method","alternative")] <- NULL



finaltTest <- cbind(c("Aggregate","Travellers","Urban Hip","Suburb Mix","Moving Up", "Male", "Female"), finaltTest)
colnames(finaltTest) <- c("Segments","Estimate","Statistic","P.Value", "DF","Conf.Low","Conf.High")

meTTest <- c(finaltTest[,"Conf.High"]-finaltTest[,"Estimate"])

finaltTest <- cbind(finaltTest,meTTest)
colnames(finaltTest) <- c("Segments","Estimate","Statistic","P.Value", "DF","Conf.Low","Conf.High","ME")

kable(finaltTest,
      caption = "T-test table for Income, both Aggregate and Segmented. Gives a 90% C.I for the population mean",
      format="simple",
      )


#mention that p-value is 0 because it is rounded by the table. It isnt actually 0

```

# A.2.2

[your comments here]

```{r A.2.2, comment= " ",fig.dim = c(3,3)}

# In this part we are dealing with a true/false variable subsribers (a bool variable either subNo or subYes)
# we want to transform this to numbers so subYes becomes 1 and subNo becomes 0

# at aggregate level we get


n = nrow(data) 
totalP = sum(data$subscribe == "subYes")/n

totalTTestP <- t.test(data$subscribe =="subYes", conf.level = 0.90)

muN <- nrow(seg_mu)
muP <- sum(seg_mu$subscribe == "subYes")/muN

smN <- nrow(seg_sm)
smP <- sum(seg_sm$subscribe == "subYes") / smN

tN <- nrow(seg_t)
tP <- sum(seg_t$subscribe == "subYes")/tN

uhN <- nrow(seg_uh)
uhP <- sum(seg_uh$subscribe == "subYes") /uhN

proportionC <- rbind(totalP,muP,smP,tP,uhP)
rownames(proportionC) <- c("Aggregate", "Moving Up", "Suburb Mix", "Travelers", "Urban Hip")

kable(proportionC,
      caption = "Aggregate Proportion and Proportion per Segment",
      col.names = "Proportion",
      format ="simple",
       )

#then look at p 284 in Newbold to figure out the confidence interval 

```

```{r A.2.2 C.I, comment = " ", fig.dim = c(3,3)}


uhTTestP <- t.test(seg_uh$subscribe == "subYes", conf.level = 0.90)

pTable <- map_df(list(totalTTestP,uhTTestP),tidy)
pTable[,c("method","alternative")] <- NULL

pTable <- cbind(c("Aggregate","Urban Hip"),pTable)
colnames(pTable) <- c("Segments","Estimate","Statistic","P.Value", "DF","Conf.Low","Conf.High")

meTTestP <- c(pTable[,"Conf.High"] - pTable[,"Estimate"] )

pTable <- cbind(pTable,meTTestP)
colnames(pTable) <- c("Segments","Estimate","Statistic","P.Value", "DF","Conf.Low","Conf.High", "ME")

kable(pTable,
      caption ="90% C.I for the population proportion of Subscribers, both Aggregate and for Urban Hip",
        format="simple",
      )

```

# A.2.3
[your comments here]

```{r A.2.3}

```

Are the underlying assumptions for calculating this interval met in this data? 

## A.3 - Confidence Intervals and the Sample Size

```{r A.3.1 Part 1}

#3.1 part 1, 2% ME

ME<-0.02
p<-0.5
Z<-qnorm(0.95,0,1)

n1<-((Z^2)*(p*(1-p))/(ME^2))

#maximize p(1-p) -> p=0.5
#n=(z^2*p(1-p))/(ME^2)
#z=qnorm(0.95)
#assume big proportion


#3.1 part 2, 1% ME

ME<-0.01
p<-0.5
Z<-qnorm(0.95,0,1)

n2<-((Z^2)*(p*(1-p))/(ME^2))


#table?

table_3_1<-cbind(n1,n2)
colnames_3_1<-c("2% ME","1% ME")
kable(table_3_1,
      digits=2,
      col.names=colnames_3_1,
      caption="Sample size to obtain a certain ME",
      format="simple")



```

|   It may not be worth the cost since the sample size would have to increase by a lot in order lower the ME only a little bit. In this case from 1691 to 6764 (around 4 times) in order to only decrease the ME from 2% to 1%. 

```{r A.3.2, comment = " "}

lNP <- 10000

xP <- totalP * lNP

propTest <- prop.test(xP,
          lNP,
          conf.level = 0.90)

propTestTable <- map_df(list(propTest), tidy)
propTestTable[,c("method","alternative")] <- NULL

propTestTable <- cbind("Aggregate",propTestTable)
colnames(propTestTable) <- c("Segments","Estimate","Statistic","P.Value", "DF","Conf.Low","Conf.High")

propMETTest <- c(propTestTable[,"Conf.High"] - propTestTable[,"Estimate"])
propTestTable <- cbind(propTestTable, propMETTest)
colnames(propTestTable) <- c("Segments","Estimate","Statistic","P.Value", "DF","Conf.Low","Conf.High", "ME")

kable(propTestTable,
      caption = "90% C.I for population proportion of Subscrbers with 10000 samples",
      format = "simple")

```


[your comments here]


How should we adjust the confidence level as the size of the sample increases? Why?



## A.4 - Confidence Intervals: Comparison of Population Means


```{r A.4.i}
travelersdata = data[data$Segment == "Travelers",]
urban_hipdata = data[data$Segment == "Urban hip",]


# getting the samplesizes
nx = nrow(travelersdata)
ny = nrow(urban_hipdata)

# data for travelers
mx <- mean(travelersdata$income)
sx <- sd(travelersdata$income)
# data for urban

my <- mean(urban_hipdata$income)
sy <- sd(urban_hipdata$income)

# refer to 8.10 in Newbold p 318

v <- (sx^2/nx + sy^2/ny)^2/ ((sx^2/nx)^2/(nx-1) + (sy^2/ny)^2/(ny-1))

t <- qt(0.95, v)

ME <- t*(sx^2/nx + sy^2/ny)^(0.5)

LCL <- (mx-my) - ME
UCL <- (mx-my) + ME







```

To determine the confidence interval for the difference of population means, we used the Welch's t-test on 80 samples of travelers and 50 samples from the urban hip segment. We assumed that observations in each sample were independently and randomly chosen, and that the populations follow normal distributions. The results showed that the 90% confidence interval for the difference of the mean income $(\bar{x}_{travelers} - \bar{x}_{Urban hip})$ was (42849, 50557), thus indicating a significant difference in the mean income between the two segments with a high degree of confidence.




